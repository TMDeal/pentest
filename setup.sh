#!/bin/bash

download_github_release() {
	repo="$1"
	shift

	all_downloads=$(curl -s "https://api.github.com/repos/$repo/releases/latest" | jq -r ".assets[] | .browser_download_url")

	for download in $all_downloads; do
		if [[ ! -z $@ ]]; then
			echo $download | grep $@ 1>/dev/null
			if [[ $? -eq 0 ]]; then
				wget -q "$download"
			fi
		else
			wget -q "$download"
		fi
	done
}

build_dive() {
	echo '[!] Building dive...'

	make 1>/dev/null

	echo '[O] Building dive complete!'
}

download_kerbrute() {
	echo '[!] Downloading kerbrute'
	if [ ! -z "$(ls -A)" ]; then
		echo '[.] Removing old files...'
		rm -rf *
	fi

	echo '[.] Downloading kerbrute binaries...'
	download_github_release "ropnop/kerbrute"

	kerbrute_binary="kerbrute_linux_amd64"
	chmod +x ./kerbrute_linux_amd64
	
	echo '[O] kerbrute download complete!'
}

download_peass() {
	echo '[!] Downloading PEASS scripts'

	if [ ! -z "$(ls -A)" ]; then
		echo '[.] Removing old files...'
		rm -rf *
	fi

	echo '[.] Downloading PEASS scripts...'
	download_github_release "carlospolop/PEASS-ng"

	echo '[O] PEASS download complete!'
}

create_symlinks() {
	printf '[!] Creating symlinks for executable files in %s/bin\n' $(pwd)

	ln -sf ../dive/dist/dive_linux_amd64/dive ./bin/dive
	echo '[.] Created symlink for dive'

	ln -sf ../kerbrute/kerbrute_linux_amd64 ./bin/kerbrute
	echo '[.] Created symlink for kerbrute'

	ln -sf ../scripts/smbver ./bin/smbver
	echo '[.] Created symlink for smbver'

	ln -sf ../scripts/tightvnc_decrypt ./bin/tightvnc_decrypt
	echo '[.] Created symlink for tightvnc_decrypt'

	ln -sf ../wesng/run ./bin/wesng
	echo '[.] Created symlink for wesng'

	ln -sf ../PRET/run ./bin/pret
	echo '[.] Created symlink for pret'

	printf '[O] All executable files symlinked! Add %s/bin to $PATH to make them available\n' $(pwd)
	echo '[!] Creating symlinks to useful system directories'

	sudo ln -sf /usr/share/windows-resources ./windows
	echo '[.] Created symlink to /usr/share/windows-resources'

	sudo ln -sf /usr/share/seclists ./seclists
	echo '[.] Created symlink to /usr/share/seclists'

	sudo ln -sf /usr/share/wordlists ./wordlists
	echo '[.] Created symlink to /usr/share/wordlists'

	sudo ln -sf /usr/share/webshells ./webshells
	echo '[.] Created symlink to /usr/share/webshells'

	echo '[O] All system directories symlinked!'
}

git submodule update --init --recursive

cd dive
build_dive
cd ..

cd kerbrute
download_kerbrute
cd ..

cd PEASS
download_peass
cd ..

create_symlinks

echo '[O] Pentest files are all ready for use!'
